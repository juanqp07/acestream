name: Actualizar M3U (acestream->http)

on:
  schedule:
    - cron: '0 * * * *'  # Ejecuta cada hora (ajustado para no saturar)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: actualizar-m3u
  cancel-in-progress: true

env:
  HOST: mediaflow
  PORT: 8888
  # Definimos las URLs separadas por espacios para usarlas en un bucle si fuera necesario
  SOURCE_URLS: >-
    https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_fuera_iptv.m3u
    https://bit.ly/peticiones1RFEF
    https://k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr.ipns.dweb.link/hashes_acestream.m3u
  OUT_DIR: "listas_procesadas"
  MODE: ${{ vars.MODE || 'mediaflow' }}

jobs:
  update:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3

      - name: Ejecutar script para actualizar múltiples M3U
        env:
          MEDIAFLOW_PASSWORD: ${{ secrets.MEDIAFLOW_PASSWORD }}
        run: |
          # Convertimos el string de URLs en argumentos para el script
          # Usamos un array para manejar correctamente las URLs
          URL_ARGS=""
          for url in ${{ env.SOURCE_URLS }}; do
            URL_ARGS="$URL_ARGS --url $url"
          done

          python update_m3u_acestream.py \
            $URL_ARGS \
            --out-dir ${{ env.OUT_DIR }} \
            --host "${{ env.HOST }}" \
            --port "${{ env.PORT }}" \
            --mode "${{ env.MODE }}" \
            --timeout 45

      - name: Commit y push de cambios
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Añadir todos los archivos procesados en la carpeta de salida
          git add ${{ env.OUT_DIR }}/*.m3u
          
          if git diff --staged --quiet; then
            echo "Sin cambios en las listas."
          else
            git commit -m "Auto: actualización de listas AceStream $(date +'%Y-%m-%d %H:%M')"
            git push origin HEAD
          fi

      - name: Subir artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: m3u-results
          path: ${{ env.OUT_DIR }}/*.m3u
